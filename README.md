# Backend API для управления пользователями и платежами

## Обзор

Этот проект представляет собой асинхронный REST API, разработанный на FastAPI для управления пользователями, администраторами, счетами и платежами. Также реализован эмулированный вебхук для обработки транзакций.

## Технологический стек

- **Python** (FastAPI, SQLAlchemy, Pydantic)
- **PostgreSQL** (в качестве базы данных)
- **Alembic** (для управления миграциями БД)
- **Docker Compose** (для контейнеризации и развертывания)
- **JWT** (для аутентификации)

## Функциональность

### Возможности пользователей

- Регистрация и вход по email/паролю
- Получение информации о себе (ID, email, полное имя)
- Просмотр списка своих счетов и балансов
- Просмотр списка своих платежей

### Возможности администратора

- Вход по email/паролю
- Получение информации о себе
- Создание, удаление и обновление пользователей
- Просмотр списка всех пользователей с их счетами и балансами

### Вебхук (эмуляция обработки платежей)

- Проверка SHA256 подписи
- Проверка существования счета (если отсутствует — создается)
- Сохранение транзакций в базе данных
- Исключение дублирующихся транзакций
- Обновление баланса счета

## Установка и запуск

### Запуск с Docker Compose

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/SaBog/dimatech-test-app.git
   cd dimatech-test-app
   ```
2. Соберите и запустите сервисы:
   ```bash
   docker-compose up --build
   ```

### Локальный запуск (без Docker)

1. Установите зависимости:

   ```bash
   python -m venv .venv
   source .venv/bin/activate  # Для Windows: .venv\Scripts\activate
   pip install -r requirements.txt
   ```

2. Настройте `.env` файл или `app/core/config.py` с данными для подключения к базе данных.

3. Примените миграции:
   ```bash
   alembic upgrade head
   ```
4. Миграция данных:
   ```bash
   python -m app.db.init_data
   ```
5. Запустите сервер FastAPI:
   ```bash
   uvicorn app.main:app --reload
   ```

API будет доступно по адресам:

- [Swagger UI](http://localhost:8000/docs)
- [Redoc](http://localhost:8000/redoc)

## Запуск тестов

```bash
pytest tests/
```

## Учетные данные

Хранятся в `app/db/init_data.py`

| Роль  | Email                 | Пароль |
| ----- | --------------------- | ------ |
| Admin | testadmin@example.com | 123    |
| User  | testuser@example.com  | 123    |

## API Эндпоинты

| Метод  | Эндпоинт                 | Описание                       |
| ------ | ------------------------ | ------------------------------ |
| POST   | `/auth/login`            | Авторизация пользователя       |
| GET    | `/users/me`              | Получение данных о себе        |
| GET    | `/users/me/accounts`     | Просмотр своих счетов          |
| GET    | `/users/me/payments`     | Просмотр своих платежей        |
| GET    | `/admin/users`           | Просмотр списка пользователей  |
| POST   | `/admin/users`           | Создание пользователя (админ)  |
| GET    | `/admin/users/{user_id}` | Получение данных пользователя  |
| PATCH  | `/admin/users/{user_id}` | Обновление данных пользователя |
| DELETE | `/admin/users/{user_id}` | Удаление пользователя          |
| POST   | `/webhook/payments`      | Обработка вебхука платежей     |
